# AutoReply AI — Универсальный AI-ассистент продаж

Десктопное приложение, которое помогает менеджерам мгновенно отвечать клиентам в **любом мессенджере** — Telegram, Instagram, Gmail, WhatsApp, и любом другом.

Менеджер нажимает горячую клавишу прямо в чате — AI читает переписку, генерирует идеальный ответ, и предлагает его вставить одной кнопкой.

---

## Как это работает (простыми словами)

```
1. Менеджер открывает любой чат (Telegram, Instagram, Gmail...)
2. Видит сообщение от клиента
3. Нажимает Cmd+Option+R (Mac) или Ctrl+Alt+R (Windows)
4. Приложение:
   а) Читает ВСЕ сообщения из окна чата (через системный API)
   б) Отправляет их в Gemini AI вместе с системным промтом
   в) Показывает всплывающее окно с предложенным ответом
5. Менеджер нажимает "Paste" — ответ вставляется в поле ввода чата
6. Менеджер проверяет и отправляет
```

**Ключевое:** приложение читает текст напрямую из интерфейса любой программы через Accessibility API операционной системы. Это НЕ скриншот — это реальный текст, включая сообщения, которые не видны на экране.

---

## Два режима работы

### Режим 1: Десктопное приложение (`app.py`) — основной

Работает в **любом мессенджере**. Запускается как иконка в трее (menu bar на Mac, system tray на Windows).

```bash
python app.py
```

### Режим 2: Gmail-бот (`main.py`) — автономный

Автоматически мониторит Gmail каждые 30 секунд. При новом письме — генерирует ответ и присылает менеджеру в Telegram с кнопками "Отправить / Редактировать / Пропустить".

```bash
python main.py
```

---

## Быстрый старт (пошагово)

### Шаг 1: Скачай проект

```bash
git clone <url-репозитория>
cd AutoReply
```

### Шаг 2: Создай виртуальное окружение (рекомендуется)

```bash
# Создаём изолированное окружение, чтобы не засорять систему
python -m venv venv

# Активируем его:
# На macOS / Linux:
source venv/bin/activate

# На Windows:
venv\Scripts\activate
```

После активации в терминале появится `(venv)` в начале строки — это значит, что окружение активно.

### Шаг 3: Установи зависимости

**macOS:**
```bash
# Основные зависимости
pip install -r requirements.txt

# Зависимости для macOS (Accessibility API)
pip install pyobjc-core pyobjc-framework-ApplicationServices pyobjc-framework-Quartz
```

Или одной командой:
```bash
./install_macos.sh
```

**Windows:**
```bash
# Основные зависимости
pip install -r requirements.txt

# Зависимости для Windows (UI Automation)
pip install uiautomation psutil mss
```

Или одной командой:
```bat
install_windows.bat
```

### Шаг 4: Настрой .env файл

Открой файл `.env` в текстовом редакторе. Он уже создан, нужно вписать свои ключи:

```env
# Gemini API — обязательно для обоих режимов
GEMINI_API_KEY=твой_ключ_от_google_ai

# Telegram Bot — нужен только для Gmail-бот режима (main.py)
TELEGRAM_BOT_TOKEN=токен_от_botfather
TELEGRAM_MANAGER_CHAT_ID=твой_chat_id

# Gmail — нужен только для Gmail-бот режима (main.py)
GMAIL_CREDENTIALS_PATH=credentials/credentials.json
GMAIL_TOKEN_PATH=credentials/token.json

# Путь к системному промту
SYSTEM_PROMPT_PATH=sales_agent_system_prompt.md
```

**Для десктопного режима (`app.py`) достаточно только `GEMINI_API_KEY`.**

### Шаг 5: Получи Gemini API ключ

1. Зайди на [Google AI Studio](https://aistudio.google.com/apikey)
2. Нажми "Create API Key"
3. Скопируй ключ и вставь в `.env` файл в строку `GEMINI_API_KEY=`

### Шаг 6: Выдай разрешения (macOS)

При первом запуске macOS попросит разрешения. Без них приложение не сможет читать текст из других окон.

1. Открой **System Settings** (Системные настройки)
2. Перейди в **Privacy & Security** → **Accessibility**
3. Нажми "+" и добавь **Terminal** (или **iTerm**, или ту программу, из которой ты запускаешь скрипт)
4. Если используешь VS Code — добавь и его тоже

На Windows дополнительных разрешений не требуется.

### Шаг 7: Запусти

```bash
python app.py
```

В трее (menu bar на Mac / system tray на Windows) появится иконка **AR**. Приложение работает!

---

## Сборка .exe / .app (для менеджера)

Чтобы менеджер не устанавливал Python — собери приложение в один файл:

```bash
# Установи PyInstaller (один раз)
pip install pyinstaller

# Собери приложение
python build.py
```

**Результат:**
- **macOS:** `dist/AutoReply AI.app` — перетащить в Applications, двойной клик для запуска
- **Windows:** `dist/AutoReply AI/AutoReply AI.exe` — скопировать папку куда удобно, двойной клик

**Что отдать менеджеру (папка содержит):**
```
AutoReply AI/
├── AutoReply AI.exe          # (или .app на Mac) — само приложение
├── .env                       # API ключи — менеджер заполняет один раз
├── sales_agent_system_prompt.md  # промт для AI — уже настроен
```

**Менеджеру нужно сделать ОДИН раз:**
1. Открыть `.env` в блокноте
2. Вставить свой `GEMINI_API_KEY=...`
3. Сохранить
4. Двойной клик на `AutoReply AI.exe` — готово!

После запуска в трее появится иконка **AR**. Хоткеи работают глобально — в любом приложении.

---

## Горячие клавиши

| Действие | macOS | Windows |
|----------|-------|---------|
| **Быстрый ответ** (текущий экран) | `Cmd + Option + R` | `Ctrl + Alt + R` |
| **Глубокий скан** (прокрутка истории) | `Cmd + Option + E` | `Ctrl + Alt + E` |
| **Client Lookup** (демо-клиенты) | `Cmd + Shift + E` | `Ctrl + Shift + E` |

### Разница между режимами:

- **Быстрый ответ** — читает то, что сейчас видно на экране. Быстро (2-3 секунды).
- **Глубокий скан** — прокручивает чат вверх 5 раз, собирая все сообщения из истории. Медленнее (5-7 секунд), но захватывает больше контекста.
- **Client Lookup** — открывает окно со списком демо-клиентов. Поиск, анализ бизнеса, генерация стартового сообщения.

---

## Всплывающее окно (overlay)

Когда AI сгенерирует ответ, появится тёмное окно в правом нижнем углу экрана:

```
┌─────────────────────────────────┐
│  AutoReply AI              [X]  │
│─────────────────────────────────│
│  AI-generated reply:            │
│                                 │
│  Привет! Спасибо за интерес     │
│  к WinBix AI. Мы создаём       │
│  AI-ассистентов для бизнеса...  │
│                                 │
│  [Copy]  [Paste]  [Regen]       │
└─────────────────────────────────┘
```

| Кнопка | Что делает |
|--------|-----------|
| **Copy** | Копирует ответ в буфер обмена. Потом сам вставишь куда нужно. |
| **Paste** | Копирует в буфер + автоматически вставляет в чат (симулирует Ctrl/Cmd+V). |
| **Regen** | Генерирует другой вариант ответа (если первый не понравился). |
| **X** / **Esc** | Закрывает окно без действия. |

Текст в окне **можно редактировать** перед отправкой — просто кликни на текст и правь.

---

## Как AI генерирует ответы

AI использует два источника информации:

### 1. Системный промт (`sales_agent_system_prompt.md`)

Это файл с инструкциями для AI — кто он, как себя вести, что продаёт, как обрабатывать возражения. Файл лежит в корне проекта, и ты можешь его редактировать под свой бизнес.

Системный промт загружается заново при каждом запросе, поэтому **изменения применяются мгновенно** — не нужно перезапускать приложение.

### 2. Контекст переписки

Приложение извлекает текст из активного окна чата через Accessibility API:
- **macOS:** AXUIElement API (тот же API, что используют screen readers)
- **Windows:** UI Automation API

Если текстовое извлечение не удалось (приложение вернуло мало текста), срабатывает **fallback** — делается скриншот экрана, и Gemini Vision читает переписку с картинки.

---

## Структура проекта

```
AutoReply/
│
├── app.py                          # Главное приложение (десктопный режим)
├── main.py                         # Gmail-бот (автономный режим)
├── config.py                       # Загрузка настроек из .env
├── overlay.py                      # Всплывающее окно с ответом (tkinter)
├── screenshot.py                   # Скриншот экрана (macOS, для fallback)
├── text_extractor.py               # Извлечение текста через Accessibility API (macOS)
├── database.py                     # SQLite база данных для Gmail-бот режима
│
├── services/
│   ├── ai_agent.py                 # Gemini AI — генерация ответов
│   ├── gmail_service.py            # Gmail API — чтение/отправка почты
│   └── telegram_bot.py             # Telegram бот — уведомления менеджеру
│
├── platform_utils/                 # Кроссплатформенная абстракция
│   ├── __init__.py                 # Автодетект ОС (macOS / Windows)
│   ├── base.py                     # Интерфейс — что должна уметь платформа
│   ├── macos_support.py            # macOS: Accessibility API, screencapture
│   └── windows_support.py          # Windows: UI Automation, mss, win32
│
├── sales_agent_system_prompt.md    # Системный промт (инструкции для AI)
├── .env                            # API ключи (НЕ коммитить в git!)
├── .env.example                    # Шаблон .env файла
├── .gitignore                      # Защита секретов от попадания в git
├── requirements.txt                # Python-зависимости
├── install_macos.sh                # Установщик для macOS
├── install_windows.bat             # Установщик для Windows
│
└── credentials/                    # Gmail OAuth (только для main.py)
    └── .gitkeep
```

---

## Подробнее о каждом файле

### `app.py` — Главное приложение

Это точка входа для десктопного режима. Что он делает:

1. Создаёт иконку в системном трее (menu bar / system tray)
2. Слушает глобальные горячие клавиши через `pynput`
3. При нажатии хоткея:
   - Определяет, в каком приложении сейчас находится пользователь
   - Извлекает текст через `platform_utils` (Accessibility API)
   - Если текста мало — делает скриншот как fallback
   - Отправляет контекст в Gemini AI
   - Показывает overlay с ответом
4. При нажатии "Paste" — возвращает фокус в исходное приложение и симулирует Ctrl/Cmd+V

### `services/ai_agent.py` — Мозг системы

Класс `AIAgent` умеет генерировать ответы тремя способами:

| Метод | Когда используется |
|-------|-------------------|
| `generate_reply_from_text()` | Основной — получает извлечённый текст из любого чата |
| `generate_reply_from_screenshot()` | Fallback — читает скриншот через Gemini Vision |
| `generate_reply()` | Для Gmail-бот режима — получает уже структурированный тред |

Каждый метод загружает системный промт из файла и формирует запрос к Gemini.

### `platform_utils/` — Кроссплатформенность

Абстракция, которая скрывает различия между macOS и Windows:

```python
from platform_utils import get_platform

platform = get_platform()
# На macOS вернёт MacOSPlatform()
# На Windows вернёт WindowsPlatform()

text, app_name = platform.extract_conversation(deep=False)
```

Каждая платформа реализует одинаковый интерфейс (`BasePlatform`), но использует разные API операционной системы.

### `overlay.py` — Всплывающее окно

Сделано на `tkinter` (встроено в Python, не требует установки). Окно:
- Всегда поверх других окон (`topmost=True`)
- Появляется в правом нижнем углу
- Текст можно редактировать
- Закрывается по Escape или кнопке X

### `main.py` — Gmail-бот (автономный режим)

Отдельный режим работы. Запускается вместо `app.py`. Как работает:

1. Авторизуется в Gmail через OAuth2
2. Каждые 30 секунд проверяет новые непрочитанные письма
3. При новом письме — загружает весь тред (всю цепочку переписки)
4. Отправляет в Gemini AI для генерации ответа
5. Присылает менеджеру в Telegram:
   - Кто написал, тема, текст последнего сообщения
   - AI-предложенный ответ
   - Кнопки: Отправить / Редактировать / Перегенерировать / Пропустить
6. Если менеджер нажимает "Отправить" — ответ уходит клиенту через Gmail

---

## Настройка Gmail-бот режима (опционально)

Если хочешь использовать автономный мониторинг Gmail (`main.py`), нужно дополнительно:

### 1. Создать Telegram-бота

1. Открой Telegram, найди бота **@BotFather**
2. Напиши ему `/newbot`
3. Придумай имя и username для бота
4. Скопируй токен (длинная строка вида `123456:ABC-DEF...`)
5. Вставь его в `.env`: `TELEGRAM_BOT_TOKEN=твой_токен`

### 2. Узнать свой Chat ID

1. Запусти бота: `python main.py`
2. Открой своего бота в Telegram и напиши `/start`
3. В логах терминала увидишь строку `Manager started bot, chat_id: 123456789`
4. Скопируй число и вставь в `.env`: `TELEGRAM_MANAGER_CHAT_ID=123456789`
5. Перезапусти `python main.py`

### 3. Настроить Gmail API

1. Зайди в [Google Cloud Console](https://console.cloud.google.com/)
2. Создай новый проект (или используй существующий)
3. В меню слева: **APIs & Services** → **Library**
4. Найди **Gmail API** и нажми **Enable**
5. Перейди в **APIs & Services** → **Credentials**
6. Нажми **Create Credentials** → **OAuth client ID**
7. Тип: **Desktop app**
8. Скачай JSON файл и сохрани как `credentials/credentials.json`
9. При первом запуске `python main.py` откроется браузер — авторизуйся в Google
10. Токен сохранится в `credentials/token.json` (повторная авторизация не потребуется)

---

## Как настроить системный промт под свой бизнес

Файл `sales_agent_system_prompt.md` содержит все инструкции для AI. Чтобы адаптировать под себя:

1. Открой файл в любом текстовом редакторе
2. Замени информацию о WinBix AI на информацию о своём продукте
3. Обнови:
   - Раздел `YOUR IDENTITY` — имя, компания
   - Раздел `PRODUCT KNOWLEDGE BASE` — описание продукта, цены, фичи
   - Раздел `OBJECTION HANDLING` — типичные возражения и ответы
   - Раздел `PRICING REFERENCE` — актуальные цены
   - Раздел `INDUSTRY-SPECIFIC VALUE PROPOSITIONS` — примеры для разных ниш
4. Сохрани файл — изменения применятся автоматически при следующем запросе

**Не нужно перезапускать приложение** — промт перечитывается из файла при каждом запросе.

---

## Частые проблемы и решения

### "Accessibility permission NOT granted" (macOS)

Приложение не может читать текст из других окон.

**Решение:**
1. System Settings → Privacy & Security → Accessibility
2. Нажми "+" и добавь Terminal (или iTerm / VS Code)
3. Перезапусти `python app.py`

### "uiautomation not installed" (Windows)

Не установлена библиотека для чтения UI-элементов.

**Решение:**
```bash
pip install uiautomation psutil mss
```

### "Gemini API error" / "API key not valid"

Неверный или отсутствующий ключ Gemini.

**Решение:**
1. Проверь `.env` файл — `GEMINI_API_KEY` должен содержать валидный ключ
2. Получи ключ на [Google AI Studio](https://aistudio.google.com/apikey)

### Overlay не появляется

Горячая клавиша может конфликтовать с другим приложением.

**Решение:**
1. Проверь лог в терминале — там написано, что происходит
2. Убедись, что приложение запущено (иконка "AR" в трее)
3. Попробуй нажать хоткей ещё раз

### Текст извлекается некорректно / мало текста

Некоторые приложения плохо поддерживают Accessibility API.

**Решение:** Приложение автоматически переключится на screenshot fallback. Если и скриншот не помогает — попробуй использовать веб-версию мессенджера в браузере (Chrome лучше всего поддерживает Accessibility).

---

## Технологии

| Компонент | Технология | Зачем |
|-----------|-----------|-------|
| AI | Google Gemini API | Генерация ответов (текст + vision) |
| Системный трей | pystray | Иконка в menu bar / system tray |
| Горячие клавиши | pynput | Глобальные хоткеи (работают в любом приложении) |
| Overlay | tkinter | Всплывающее окно (встроено в Python) |
| Буфер обмена | pyperclip | Копирование текста |
| Автовставка | pyautogui | Симуляция Cmd/Ctrl+V |
| Текст (macOS) | pyobjc + AXUIElement | Чтение текста из любого приложения |
| Текст (Windows) | uiautomation | Чтение текста из любого приложения |
| Скриншот (macOS) | screencapture | Встроенная утилита macOS |
| Скриншот (Windows) | mss | Быстрые кроссплатформенные скриншоты |
| Email | Gmail API | Чтение и отправка писем (для bot-режима) |
| Нотификации | python-telegram-bot | Telegram-бот (для bot-режима) |
| База данных | SQLite + aiosqlite | Хранение переписок (для bot-режима) |
| Конфиг | python-dotenv | Загрузка .env файла |

---

## Безопасность

- **API ключи** хранятся только в `.env` файле, который добавлен в `.gitignore` — они **никогда не попадут в git**
- **Gmail OAuth credentials** хранятся в `credentials/` — тоже в `.gitignore`
- Приложение **не отправляет данные** никуда, кроме Google Gemini API
- Скриншоты сохраняются во временную папку и перезаписываются при каждом запросе
- На Windows не требуется никаких специальных разрешений
- На macOS требуется только Accessibility permission

---

## Вопросы?

Если что-то не работает или непонятно — создай issue в репозитории с описанием проблемы и логом из терминала.
